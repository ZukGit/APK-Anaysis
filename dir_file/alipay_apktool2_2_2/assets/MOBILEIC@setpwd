{"time":"0007","tplId":"MOBILEIC@setpwd","publishVersion":"150603","tag":"MOBILEIC","name":"setpwd","data":{"tag":"html","children":[{"tag":"head","children":[{"tag":"meta","src":"VIVerifyCore.bundle/mic.i18n","type":"i18n"},{"tag":"link","rel":"stylesheet","href":"VIVerifyCore.bundle/mic.css"},{"tag":"script","src":"VIVerifyCore.bundle/vi-amc.js"},{"tag":"script","src":"VIVerifyCore.bundle/mic.js"},{"tag":"meta","src":"android-phone-securitycommon-verifyidentitybiz/mic.i18n","type":"i18n"},{"tag":"link","rel":"stylesheet","href":"android-phone-securitycommon-verifyidentitybiz/mic.css"},{"tag":"script","src":"android-phone-securitycommon-verifyidentitybiz/vi-amc.js"},{"tag":"script","src":"android-phone-securitycommon-verifyidentitybiz/mic.js"},{"tag":"script","children":[{"text":"var getTag = amc.fn.getById;\n        var hide = amc.fn.hide;\n        var show = amc.fn.show;\n        var rpc = amc.rpcData;\n\n        var tipsSet = '{{spwd_pay}}';\n        var tipsRepeat = '{{confirm_again}}';\n        var actionSet = '';\n        var actionRepeat = '';\n        var protocols = [{\n            'text': '{{alipay_serve_protocol}}',\n            'url': 'https://ds.alipay.com/fd-inhm9zcq/index.html'\n        }, {\n            'text': '{{baoxian_protocol}}',\n            'url': 'https://ds.alipay.com/baoxian/zhxprotocol.htm'\n        }];\n\n        //### 是否给用户保险\n        var canGiveInsurance = false;\n        //### 是否显示支付宝服务协议\n        var showServiceProtocol = true;\n        //### 要显示的协议个数\n        var protocolCount = 0;\n        //### 只显示一个协议时的下标\n        var protocolIndex = 0;\n        //### 小额免密开关\n        var checkbox = null;\n        //### 小额免密开关文案\n        var checkLabel = null;\n\n        //### 密文密码\n        var encryptedPassword = null;\n\n        var pubKey = rpc.pubKey;\n\n        //### 初始化\n        function init() {\n            var nav = amc.fn.getNav(amc.res.navBack, '{{return}}', '{{set_pwd}}', null, null, onBack, null);\n            getTag('bodyContainer').insertBefore(nav, getTag('mainBody'));\n            // Android平台没有白色菊花，需要特殊处理\n            if (amc.isAndroid) {\n                getTag('loading').src = amc.path + 'alipay_msp_indicator_white_loading';\n            }\n            //外部商户Q转T,正常Q用户支付(无资产)\n            if (rpc.setSpwdType === 'quser') {\n                actionSet = '/cashier/setSpwd';\n                actionRepeat = '/cashier/saveSpwd';\n            } else if (rpc.setSpwdType === 'complete') {\n                //淘宝Q用户支付(有资产)\n                tipsSet = '{{pay_spwd}}';\n                actionSet = '/complete/spwd';\n                actionRepeat = '/complete/savespwd';\n                showServiceProtocol = false;\n            }\n            initCheckBox();\n\n            getTag('tips').innerText = tipsSet;\n            initPwdInput('spwd');\n            getTag('spwd').focus();\n        }\n\n        function initPwdInput(tagName) {\n            var pluginInitData = pluginInitData || {};\n            pluginInitData['pubKey'] = pubKey;\n            var pluginInitDataString = JSON.stringify(pluginInitData);\n            getTag(tagName).src = pluginInitDataString;\n        }\n\n        //### 处理第一次请求成功后，服务端返回的数据.\n        function handleResponse(data) {\n\n            //### 是否显示小额免密推荐文案\n            var recommendNoPwd = (data['recommendNoPwd'] === 'true');\n            //### 是否选中小额免密开关\n            checkbox.checked = (data['selectOpenNoPwd'] === 'true');\n            canGiveInsurance = (data['canGiveBaoxian'] === 'true');\n\n            checkLabel.innerText = canGiveInsurance ? '{{can_insuranced}}' : '{{insuranced}}';\n\n            if (recommendNoPwd) {\n                show('checkArea');\n            } else {\n                hide('checkArea');\n            }\n\n            protocolCount = 0;\n            protocolIndex = 0;\n            if (showServiceProtocol) {\n                protocolCount++;\n                protocolIndex = 0;\n            }\n            if (recommendNoPwd && canGiveInsurance) {\n                protocolCount++;\n                protocolIndex = 1;\n            }\n            show('agreeProtocol');\n\n            if (protocolCount === 1) {\n                getTag('protocol').innerText = protocols[protocolIndex]['text'] || '';\n                if (protocolIndex === 1) {\n                    // 只有保险协议则显示 查看:<<保险协议>>\n                    getTag('agree').innerText = '{{look}}';\n                }\n            } else if (protocolCount === 2) {\n                getTag('protocol').innerText = '{{user_agreement}}';\n            } else {\n                hide('agreeProtocol');\n            }\n        }\n\n        //第一遍校验是否成功\n        function isFirstVerifySuccess(data) {\n            return (data['verifyCode'] === 'CONTINUE') ? true : false;\n        }\n\n        function canRedoVerify(data) {\n            return (data['verifyCode'] === 'RETRY') ? true : false;\n        }\n\n        //### 初次提交，服务器进行密码的规范性校验\n        function onFirstInput() {\n            var obj = {};\n            obj['eventName'] = 'vi_rpc_validate';\n            obj['actionName'] = 'VERIFY_CHECK_PWD';\n            obj['params'] = {\n                'encryptPwd': encryptedPassword\n            };\n\n            document.asyncSubmit(obj, function(data) {\n                data['pageloading'] = '0';\n                amc.fn.shouldShowBtnIndicator(data, 'nextBtn', 'loading');\n\n                if (isFirstVerifySuccess(data)) { //校验成功，此处的校验成功\n                    handleResponse(data);\n                    hide('spwdBox');\n                    hide('firstPage');\n                    show('spwdRepeatBox');\n                    show('secondPage');\n\n                    initPwdInput('spwdRepeat');\n                    getTag('tips').innerText = tipsRepeat;\n                    getTag('spwdRepeat').value = '';\n                    getTag('nextBtn').disabled = true;\n                    getTag('spwdRepeat').focus();\n                } else { //校验失败\n                    var verifyMessage = data['verifyMessage'] || '人气太旺了，请稍后再试';\n                    if(canRedoVerify(data)){\n                        getTag('spwd').disabled = false;\n                        getTag('spwd').value = '';\n                        resetErrMsg(verifyMessage);\n                        getTag('spwd').focus();\n                    }else{\n                        amc.fn.viAlert({\n                            \"title\": '',\n                            \"message\": verifyMessage,\n                            \"button\": '{{confirm_btn}}'\n                        }, function() {\n                            mic.fn.onBackWithResponse(data);\n                        });\n                    }\n                }\n            });\n        }\n\n        //### 提交按钮\n        function onSubmit() {\n            //提交给服务器进行保存。 Notice:出于安全考虑，这里的JS无法得到密码的实际内容。\n            var obj = {};\n            obj['eventName'] = 'vi_rpc_validate';\n            obj['actionName'] = 'VERIFY_COMPLETE_PWD';\n            obj['params'] = {\n                'encryptPwd': encryptedPassword\n            };\n\n            document.asyncSubmit(obj, function(data) {\n                data['pageloading'] = '0';\n                amc.fn.shouldShowBtnIndicator(data, 'nextBtn', 'loading');\n\n                var verifyMessage = data['verifyMessage'] || '人气太旺了，请稍后再试';\n                if (!Boolean(data['verifySuccess'])) { //服务端校验失败\n                    if(canRedoVerify(data)){//允许重来\n                        resetErrMsg(verifyMessage);\n                        againOnce();\n                    }else{\n                        amc.fn.viAlert({\n                            \"title\": '',\n                            \"message\": verifyMessage,\n                            \"button\": '{{confirm_btn}}'\n                        }, function() {\n                            mic.fn.onBackWithResponse(data);\n                        });\n                    }\n                } else {\n                    mic.fn.onBackWithResponse(data);\n                }\n            });\n\n            amc.fn.shouldShowBtnIndicator({\n                'pageloading': '1'\n            }, 'nextBtn', 'loading');\n        }\n\n        /*\n         * 重新设置一次\n         */\n        function againOnce() {\n            getTag('spwd').value = '';\n\n            show('spwdBox');\n            hide('spwdRepeatBox');\n            hide('secondPage');\n            show('firstPage');\n\n            getTag('tips').innerText = tipsSet;\n            getTag('spwd').focus();\n        }\n\n        // 打开协议\n        function showProtocol() {\n            getTag('spwdRepeat').blur();\n            // getTag('spwd').blur();\n            \n            // 一个协议\n            if (protocolCount === 1) {\n                var obj = {};\n                obj['eventName'] = 'vi_external_action';\n                var openUrl = protocols[protocolIndex]['url'];\n                obj['params'] = {\n                    'url': openUrl,\n                    'action_name': 'openUrl'\n                };\n                document.submit(obj);\n                return;\n            }\n            // 两个协议\n            var protocolArray = new Array();\n            for (var i = 0; i < protocols.length; i++) {\n                protocolArray.push(protocols[i]['text']);\n            }\n            document.actionSheet({\n                'btns': protocolArray,\n                'cancelBtn': '{{cancel}}'\n            }, function(data) {\n                document.submit({\n                    'action': {\n                        'name': \"loc:openweb('\" + protocols[data.index]['url'] + \"','\" + protocols[data.index]['text'] + \"')\"\n                    }\n                });\n            });\n        }\n\n        // 重置错误消息\n        function resetErrMsg(errMsg) {\n            errMsg = errMsg || '';\n            getTag('errMsg').innerText = errMsg || '';\n\n            if (errMsg) {\n                show('errMsgBox');\n            } else {\n                hide('errMsgBox');\n            }\n        }\n\n        // 推荐免密的checkbox\n        function initCheckBox() {\n\n            var checkArea = getTag('checkArea');\n            checkbox = amc.fn.create('input');\n            checkArea.appendChild(checkbox);\n            checkbox.type = 'checkbox';\n            checkbox.className = 'amc-checkbox amc-margin-r-s';\n            checkbox.checked = false;\n\n            checkLabel = amc.fn.create('label');\n            checkLabel.className = 'amc-font-m amc-flex-1';\n\n            // 先撑满右边区域\n            var checkLabelDiv = amc.fn.create('div');\n            checkLabelDiv.style.cssText = 'flex:1.0;';\n            checkLabelDiv.appendChild(checkLabel);\n\n            checkArea.appendChild(checkLabelDiv);\n        }\n\n        //### 后退\n        function onBack() {\n            //如果是在第二页则返回\n            if (!isFirstPage()) {\n                againOnce();\n            } else {\n                //如果是在第一页则退出\n                mic.fn.onBack();\n            }\n        }\n\n        function onKeyDown() {\n            if (event.which == 4) {\n                onBack();\n            }\n        }\n\n        function isFirstPage() {\n            return (getTag('spwdBox').style.display === 'none') ? false : true;\n        }\n\n        function onPwdConfirmed(encryptedPwd) {\n            //更新密码\n            encryptedPassword = encryptedPwd;\n\n            if (isFirstPage()) {\n                //第一页\n                onFirstInput();\n            } else {\n                //第二页\n                // onSubmit();\n            }\n        }\n\n        function onPwdChanged(pwdLength) {\n            if (Number(pwdLength) >= 6) {\n                resetErrMsg();\n            }\n\n            getTag('nextBtn').disabled = !(Number(pwdLength) >= 6);\n        }","tag":"text"}]},{"tag":"style","children":[{"text":".err-msg-box {\n            justify-content: center;\n            display: none;\n        }\n\n        .err-msg-text {\n            color: #f4333c;\n        }\n\n        .err-info-text {\n            color: #a5a5a5;\n        }\n\n        .check-area-box {\n            align-items: flex-start;\n        }\n\n        .amc-nav-r-box {\n            display: none;\n        }","tag":"text"}]}]},{"id":"body","onload":"init()","tag":"body","children":[{"id":"bodyContainer","tag":"div","children":[{"id":"mainBody","tag":"div","children":[{"tag":"div","children":[{"id":"tips","tag":"label","css":"amc-font-m amc-text-center amc-flex-1"}],"css":"amc-flex-center"},{"tag":"div","children":[{"id":"spwdBox","tag":"div","children":[{"id":"spwd","tag":"embed","value":"","src":"payspwd","type":"VIPayPwdView","css":"amc-pwd-input amc-spwd-height","oninput":""}],"css":"vi-amc-spwd-box"},{"id":"spwdRepeatBox","tag":"div","children":[{"id":"spwdRepeat","tag":"embed","value":"","src":"payspwd","type":"VIPayPwdView","css":"amc-pwd-input amc-spwd-height","oninput":""}],"css":"vi-amc-spwd-box amc-hidden"}],"css":"amc-v-box amc-pd-tb"},{"id":"errMsgBox","tag":"div","children":[{"id":"errMsg","tag":"label","children":[{"text":"{{pwd-error-repeat}}","tag":"text"}],"css":"err-msg-text"}],"css":"err-msg-box amc-pd-b"},{"id":"firstPage","tag":"label","children":[{"text":"{{pwd-notice}}","tag":"text"}],"css":"err-info-text amc-font-m amc-margin-l-xs"},{"id":"secondPage","tag":"div","children":[{"tag":"div","children":[{"id":"checkArea","tag":"div","css":"check-area-box amc-pd-b"},{"id":"agreeProtocol","tag":"div","children":[{"id":"agree","tag":"label","children":[{"text":"{{agree}}","tag":"text"}],"css":"amc-font-m amc-margin-r-xs"},{"id":"protocol","tag":"label","children":[{"text":"{{alipay_serve_protocol}}","tag":"text"}],"onclick":"showProtocol()","css":"amc-font-m amc-theme-color"}],"css":"agree-box amc-margin-b-l"}],"css":"amc-v-box"},{"tag":"div","children":[{"id":"loading","tag":"img","src":"indicatior","css":"amc-loading-img amc-text-white-clolor amc-hidden"},{"id":"nextBtn","tag":"button","children":[{"text":"{{next}}","tag":"text"}],"onclick":"onSubmit()","css":"amc-btn-primary","disabled":"true"}],"css":"amc-align-center amc-justify-center amc-btn-primary"}],"css":"amc-v-box amc-hidden"}],"css":"amc-main amc-pd-lr amc-scroll-flex"}],"css":"mic-fullscreen"}],"onkeydown":"onKeyDown();","css":"mic-body-opacity"}]},"format":"JSON","tplVersion":"5.1.9"}